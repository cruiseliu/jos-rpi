<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>JOS-RPi: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">JOS-RPi
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">JOS-RPi Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><table class="doxtable">
<tr>
<th>文件名 </th><th>主要功能  </th></tr>
<tr>
<td>boot.S </td><td>启动文件, 初始化栈和 bss </td></tr>
<tr>
<td>main.cpp </td><td>C 代码入口, 主要负责初始化 </td></tr>
<tr>
<td><a class="el" href="uart_8h.html" title="This file is copied from raspbootin. ">uart.h</a> <br />
 <a class="el" href="uart_8cpp.html" title="This file is copied from raspbootin. ">uart.cpp</a> </td><td>UART I/O, 来自 raspbootin </td></tr>
<tr>
<td><a class="el" href="screen_8h_source.html">screen.h</a> <br />
 screen.cpp </td><td>Framebuffer 操作 </td></tr>
<tr>
<td>font.cpp </td><td><a class="el" href="namespaceScreen.html" title="The RPi graphic system. ">Screen</a> 使用的字体数据 </td></tr>
<tr>
<td>logo.cpp </td><td><a class="el" href="namespaceScreen.html" title="The RPi graphic system. ">Screen</a> 使用的logo数据 </td></tr>
<tr>
<td><a class="el" href="console_8h_source.html">console.h</a> <br />
 console.cpp </td><td>I/O 设备的封装 </td></tr>
<tr>
<td><a class="el" href="monitor_8h_source.html">monitor.h</a> <br />
 monitor.cpp </td><td>内核 shell </td></tr>
<tr>
<td><a class="el" href="stdio_8h.html" title="Functions similar to standard library. ">stdio.h</a> <br />
 stdio.cpp </td><td>将 Console 封装成标准库格式 </td></tr>
<tr>
<td><a class="el" href="string_8h.html" title="Standard functions, that&#39;s all. ">string.h</a> <br />
 string.cpp </td><td>类似标准库 </td></tr>
<tr>
<td><a class="el" href="common_8h_source.html">common.h</a> </td><td>通用的 typedef 及函数 </td></tr>
<tr>
<td>lib/_*div*.S </td><td>除法库, 来自 Chromium OS </td></tr>
<tr>
<td>lib/libcsud.a<br />
lib/keyboard.S </td><td>键盘驱动, 来自剑桥教程 </td></tr>
</table>
<p>其他文件中除了 kernel.ld 和 Makefile 外都是非必须的.</p>
<p>其中 boot.S, main.cpp, <a class="el" href="uart_8h.html" title="This file is copied from raspbootin. ">uart.h</a>/cpp, kernel.ld 这几个文件和之前提交过的报告中差别不大, 不再赘述.</p>
<p>以下是其他硬件相关部分的说明.</p>
<h2>Framebuffer</h2>
<p>JOS 中的输出有串口, 并口, VGA text-mode 这三种方式, 其中串口和并口直接输出字节流, 和 UART 类似, VGA text-mode 则是 PC 特有的功能, 树莓派及其他 ARM 平台均无法使用.</p>
<p>树莓派中 CPU 和 GPU 使用"邮箱"互相通信. Framebuffer 的初始化方式是 CPU 在内存中分配一段空间并写入配置, 然后将其地址通过邮箱发给 GPU, GPU 收到后会将包括 framebuffer 指针在内的一些必要信息写回这个地址, 之后 CPU 就可以直接向 framebuffer 读取或写入每个像素的颜色.</p>
<p>方便起见我使用了32位色深并禁用了 alpha 通道, 这种设置的效果和24位色是一样的, 但因为 framebuffer 中每个像素的地址都是按字对齐的所以操作更加方便.</p>
<p>为了显示文字, 我们还需要一个点阵字体(当然如果你够闲用 TrueType 也不是不行), 我在网上找了一个 <a href="http://www.proggyfonts.net/download">Proggy Clean</a> 字体, 然后半手动地把它转成了二进制位图格式.</p>
<p>另外为了展示高端大气的 framebuffer 模式之优越性, 我在启动屏幕上加了一个北大的 logo, 没什么实际意义.</p>
<p>现存的主要问题是滚屏速度太慢, 我也不知道该怎么办.</p>
<p>这部分内容主要参考了 <a href="http://elinux.org/RPi_Framebuffer">eLinux 文档</a> 和 <a href="http://www.cl.cam.ac.uk/projects/raspberrypi/tutorials/os/">剑桥的教程</a>.</p>
<p>相关文档: <a class="el" href="namespaceScreen.html" title="The RPi graphic system. ">Screen</a></p>
<h2>除法例程</h2>
<p>树莓派使用的是 ARMv6 处理器, 这种架构的一大特色是没有除法指令.</p>
<p>从编译器的报错可以看出来, gcc 使用的除法函数是 <code>__aeabi_uldivmod</code> 等, 把这个名字扔到 Google 上搜一下就能找到 Chromium OS 的<a href="https://chromium.googlesource.com/chromiumos/third_party/u-boot-v1/+/master/arch/arm/lib/_uldivmod.S">源代码</a>, 我直接复制过来用了, 只需要改一点点.</p>
<h2>Backtrace</h2>
<p>首先要加上 <code>-fno-omit-frame-pointer</code> 编译参数, 直接用栈指针和机器码猜栈帧大小我可玩不来.</p>
<p>ARM 的栈帧结构在官方文档中有<a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0041c/Cegbajdj.html">介绍</a>, <em>不过是错的</em></p>
<p>反汇编可以看到真正的栈帧是这样生成的: </p><pre class="fragment">push {fp, lr}
add  fp, sp, #4
</pre><p>所以 fp 指向的是 lr (旧 pc) 没错, 但它下面的就是旧 fp, 再下面就是通用寄存器了. 知道这些 backtrace 就好写了.</p>
<p>另外在网上看到了个读寄存器的简易方法: </p><pre class="fragment">register uint32_t reg_fp asm("fp");
uint32_t fp = reg_fp;
</pre><p>个人觉得比内联汇编优雅.</p>
<p>相关文档: <a class="el" href="namespaceMonitor.html#a6a88ac746dfd01e0b27bae94f249331a" title="Display the stack backtrace. ">Monitor::backtrace</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Dec 19 2014 12:25:34 for JOS-RPi by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
